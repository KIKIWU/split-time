{"version":3,"file":"split_time.js","sources":["es/entry-list.js","es/task-queue.js","es/utils.js","es/observer.js","es/index.js"],"sourcesContent":["export default class EntryList extends Array {\n    constructor(entries) {\n        super(...entries);\n        this._entries = entries;\n    }\n    getEntries() {\n        return this._entries;\n    }\n    getEntriesByType(type) {\n        return this._entries.filter((e) => e.entryType === type);\n    }\n    getEntriesByName(name, type) {\n        return this._entries\n            .filter((e) => e.name === name)\n            .filter((e) => (type ? e.entryType === type : true));\n    }\n}\n//# sourceMappingURL=entry-list.js.map","import EntryList from './entry-list';\nconst INTERVAL = 100;\nclass TaskQueue {\n    constructor({ registeredObservers = new Set(), processedEntries = new Set() } = {}) {\n        this.registeredObservers = registeredObservers;\n        this.processedEntries = processedEntries;\n        this.timerId = null;\n    }\n    // 添加一个 task\n    add(observer) {\n        this.registeredObservers.add(observer); // 注册一个 observer\n        if (this.registeredObservers.size === 1) { // 只在刚有 observer 的时候监听一次\n            this.observe(); // 开始监听\n        }\n    }\n    remove(observer) {\n        this.registeredObservers.delete(observer);\n        if (!this.registeredObservers.size) {\n            this.disconnect();\n        }\n    }\n    disconnect() {\n        self.clearInterval(this.timerId);\n        this.timerId = null;\n    }\n    // call callbacks function when CPU idle\n    idleCallback() {\n        // Queue task to process all observer buffers\n        const task = () => this.registeredObservers.forEach(this.processBuffer);\n        if ('requestAnimationFrame' in self) {\n            self.requestAnimationFrame(task);\n        }\n        else {\n            self.setTimeout(task, 0);\n        }\n    }\n    // 监听\n    observe() {\n        // 利用 interval 不断执行\n        this.timerId = self.setInterval(this.processEntries.bind(this), INTERVAL);\n    }\n    // 执行条目\n    processEntries() {\n        const entries = this.getNewEntries(); // 获取新的性能条目\n        entries.forEach((entry) => {\n            const { entryType } = entry;\n            const observers = this.getObserversForType(this.registeredObservers, entryType); // 获取 entryType 的 entry\n            // Add the entry to observer buffer\n            observers.forEach((observer) => {\n                observer.buffer.add(entry);\n            });\n            // Mark the entry as processed\n            this.processedEntries.add(entry);\n        });\n        this.idleCallback();\n    }\n    // 调用 callback 返回一次 observe 的 buffer，buffer 中是这次所有的 entry\n    processBuffer(observer) {\n        const entries = Array.from(observer.buffer);\n        const entryList = new EntryList(entries);\n        observer.buffer.clear();\n        if (entries.length && observer.callback) {\n            !observer.useNative && observer.callback.call(undefined, entryList, observer);\n        }\n    }\n    getNewEntries() {\n        // TODO: 扩充 entry 来源\n        const entries = self.performance.getEntries();\n        return entries.filter((entry) => !this.processedEntries.has(entry));\n    }\n    getObserversForType(observers, type) {\n        return Array.from(observers)\n            .filter((observer) => observer.entryTypes.some((t) => t === type));\n    }\n}\nexport default TaskQueue;\n//# sourceMappingURL=task-queue.js.map","export const ifSupported = 'PerformanceObserver' in self && typeof PerformanceObserver === 'function';\nexport const totalEntryTypes = [\n    'element',\n    'first-input',\n    'frame',\n    'largest-contentful-paint',\n    'layout-shift',\n    'longtask',\n    'mark',\n    'measure',\n    'navigation',\n    'paint',\n    'resource',\n    'server'\n];\n//# sourceMappingURL=utils.js.map","import TaskQueue from './task-queue';\nimport EntryList from './entry-list';\nimport { ifSupported } from './utils';\nconst globalTaskQueue = new TaskQueue(); // 是否可以写成 static?\nclass SplitTime {\n    constructor(callback) {\n        this.entryTypes = [];\n        this.callback = callback;\n        this.buffer = new Set();\n        this.taskQueue = globalTaskQueue;\n        this.useNative = false;\n    }\n    observe(options) {\n        // TODO: 参数校验\n        // TODO: 支持 entryTypes & type\n        // TODO: 支持 bufferd\n        const { entryTypes } = options;\n        let supportedOptionsEntryTypes = [];\n        let unsupportedOptionsEntryTypes = entryTypes;\n        if (ifSupported) {\n            const { supportedEntryTypes } = PerformanceObserver;\n            const supportedEntryTypesSet = new Set(supportedEntryTypes);\n            supportedOptionsEntryTypes = entryTypes.filter((entryType) => supportedEntryTypesSet.has(entryType));\n            unsupportedOptionsEntryTypes = entryTypes.filter((entryType) => !supportedEntryTypesSet.has(entryType));\n            if (supportedOptionsEntryTypes.length) {\n                this.useNative = true;\n                new PerformanceObserver((list, observer) => {\n                    this.processEntries(list);\n                })\n                    .observe({ entryTypes: supportedOptionsEntryTypes });\n            }\n        }\n        if (unsupportedOptionsEntryTypes.length) {\n            this.entryTypes = unsupportedOptionsEntryTypes;\n            this.taskQueue.add(this);\n        }\n    }\n    disconnect() {\n        this.taskQueue.remove(this);\n    }\n    takeRecords() {\n        const entries = Array.from(this.buffer);\n        return new EntryList(entries);\n    }\n    processEntries(list) {\n        const entries = Array.from(this.buffer);\n        const nativeEntries = (list && list.getEntries()) || [];\n        // Combine entries from native & SplitTime\n        const entryList = new EntryList([...entries, ...nativeEntries]);\n        this.buffer.clear();\n        this.callback(entryList, this);\n    }\n}\nSplitTime.supportedEntryTypes = [];\nexport default SplitTime;\n//# sourceMappingURL=observer.js.map","import SplitTime from './observer';\nexport default SplitTime;\n//# sourceMappingURL=index.js.map"],"names":[],"mappings":"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"}